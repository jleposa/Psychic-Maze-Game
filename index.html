<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Psychic Maze Game</title>
  <style>
    /* ========== Layout & Frame ========== */
    body {
      margin: 0;
      background: #000;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      font-family: sans-serif;
      color: #fff;
    }
    #frame {
      border: 4px solid #0f0;
      padding: 10px;
      box-shadow: 0 0 20px #0f0;
      position: relative;
      width: 80vw;
      height: 80vh;
      max-width: 900px;
      max-height: 700px;
    }
    #title {
      position: absolute;
      top: -28px;
      left: 10px;
      background: #000;
      padding: 2px 8px;
      font-size: 20px;
      font-weight: bold;
      color: #0f0;
    }
    /* ========== Game Container ========== */
    #game-container {
      width: 100%;
      height: 100%;
      position: relative;
    }
    /* ========== HUD & Legend ========== */
    #HUD {
      position: absolute;
      top: 10px; left: 10px;
      z-index: 2;
      font-size: 16px;
    }
    #legend {
      position: absolute;
      bottom: 10px; left: 10px;
      z-index: 2;
      background: rgba(0,0,0,0.5);
      padding: 8px;
      font-size: 14px;
      line-height: 1.4;
    }
    #message {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%,-50%);
      color: #0f0;
      font-size: 32px;
      text-shadow: 0 0 8px #0f0;
      display: none;
      z-index: 3;
    }
  </style>
</head>
<body>
  <div id="frame">
    <div id="title">Psychic Maze Game</div>
    <div id="game-container"></div>
    <div id="HUD">
      Orbs: <span id="count">0</span> |
      Powers: [X-Ray = X]
    </div>
    <div id="legend">
      <strong>Controls:</strong><br>
      ‚Ä¢ Click to lock pointer<br>
      ‚Ä¢ W/A/S/D or ‚Üë‚Üê‚Üì‚Üí to move<br>
      ‚Ä¢ X to toggle X-Ray (needs ‚â•2 orbs)
    </div>
    <div id="message">üéâ You Escaped! üéâ</div>
  </div>

  <script type="module">
    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.module.js';
    import { PointerLockControls } from 'https://cdn.jsdelivr.net/npm/three@0.155.0/examples/jsm/controls/PointerLockControls.js';

    let camera, scene, renderer, controls;
    const walls = [], items = [];
    let EXIT = new THREE.Vector3();
    let orbCount = 0, xrayOn = false;
    const tile = 10, wallH = 10;
    const MAZE = [
      '##########',
      '#P..I...E#',
      '#.####.#.#',
      '#......#.#',
      '#.##.#...#',
      '#...##.I.#',
      '#I.......#',
      '##########'
    ];

    init();
    animate();

    function init() {
      // Scene & Camera
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x202020);

      const container = document.getElementById('game-container');
      const width = container.clientWidth;
      const height = container.clientHeight;
      camera = new THREE.PerspectiveCamera(75, width / height, 1, 1000);

      // Renderer
      renderer = new THREE.WebGLRenderer();
      renderer.setSize(width, height);
      container.appendChild(renderer.domElement);

      // Controls
      controls = new PointerLockControls(camera, renderer.domElement);
      renderer.domElement.addEventListener('click', () => controls.lock());
      scene.add(controls.getObject());

      // Light
      const hemi = new THREE.HemisphereLight(0xffffbb, 0x080820, 1);
      scene.add(hemi);

      // Build Maze
      MAZE.forEach((row, z) => {
        row.split('').forEach((c, x) => {
          const px = (x - MAZE[0].length/2) * tile;
          const pz = (z - MAZE.length/2) * tile;
          if (c === '#') {
            const geo = new THREE.BoxGeometry(tile, wallH, tile);
            const mat = new THREE.MeshLambertMaterial({ color: 0x444444, transparent: true, opacity: 1 });
            const mesh = new THREE.Mesh(geo, mat);
            mesh.position.set(px, wallH/2, pz);
            scene.add(mesh);
            walls.push(mesh);
          }
          if (c === 'P') {
            controls.getObject().position.set(px, 2, pz);
          }
          if (c === 'I') {
            const orb = new THREE.Mesh(
              new THREE.SphereGeometry(2, 8, 8),
              new THREE.MeshBasicMaterial({ color: 0xffff00 })
            );
            orb.position.set(px, 2, pz);
            scene.add(orb);
            items.push(orb);
          }
          if (c === 'E') {
            const exit = new THREE.Mesh(
              new THREE.CylinderGeometry(4, 4, 1, 16),
              new THREE.MeshBasicMaterial({ color: 0x00ff00 })
            );
            exit.position.set(px, 0.5, pz);
            scene.add(exit);
            EXIT.set(px, 0.5, pz);
          }
        });
      });

      // Input
      window.addEventListener('keydown', onKeyDown);
      window.addEventListener('keyup', onKeyUp);
      window.addEventListener('resize', onResize);
    }

    const move = { forward: 0, right: 0 };
    function onKeyDown(e) {
      if (e.code === 'KeyX' && orbCount >= 2) {
        xrayOn = !xrayOn;
        walls.forEach(w => w.material.opacity = xrayOn ? 0.3 : 1);
      }
      if (['KeyW','ArrowUp'].includes(e.code))    move.forward = 1;
      if (['KeyS','ArrowDown'].includes(e.code))  move.forward = -1;
      if (['KeyA','ArrowLeft'].includes(e.code))  move.right   = -1;
      if (['KeyD','ArrowRight'].includes(e.code)) move.right   = 1;
    }
    function onKeyUp(e) {
      if (['KeyW','ArrowUp','KeyS','ArrowDown'].includes(e.code))    move.forward = 0;
      if (['KeyA','ArrowLeft','KeyD','ArrowRight'].includes(e.code)) move.right   = 0;
    }
    function onResize() {
      const container = document.getElementById('game-container');
      const w = container.clientWidth, h = container.clientHeight;
      renderer.setSize(w, h);
      camera.aspect = w / h;
      camera.updateProjectionMatrix();
    }

    function animate() {
      requestAnimationFrame(animate);
      if (controls.isLocked) {
        const speed = 0.2;
        controls.moveForward(move.forward * speed);
        controls.moveRight(move.right * speed);

        // Collect Orbs
        items.slice().forEach((orb, i) => {
          if (controls.getObject().position.distanceTo(orb.position) < 3) {
            scene.remove(orb);
            items.splice(i, 1);
            orbCount++;
            document.getElementById('count').textContent = orbCount;
          }
        });

        // Check Exit
        if (controls.getObject().position.distanceTo(EXIT) < 3) {
          document.getElementById('message').style.display = 'block';
          controls.unlock();
        }
      }
      renderer.render(scene, camera);
    }
  </script>
</body>
</html>
